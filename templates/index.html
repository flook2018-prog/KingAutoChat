<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KingAutoChat - Admin</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
body { font-family: 'Inter', sans-serif; margin:0; padding:0; background:#f4f6f8; }
header { background:#1abc9c; color:#fff; padding:1rem 2rem; font-size:1.5rem; font-weight:bold;}
.container { display:flex; padding:1rem; gap:1rem;}
.cases, .chat, .profile { background:#fff; border-radius:10px; padding:1rem; flex:1;}
.cases { max-width:250px; }
.chat { flex:2; max-height:80vh; overflow-y:auto; }
.profile { max-width:250px; }
.case { padding:0.5rem; border-bottom:1px solid #eee; cursor:pointer; }
.message { margin:0.5rem 0; padding:0.5rem; border-radius:8px; max-width:80%; }
.customer { background:#eee; align-self:flex-start; }
.admin { background:#1abc9c; color:#fff; align-self:flex-end; }
#message-input { width:100%; padding:0.5rem; border-radius:8px; border:1px solid #ccc; margin-top:0.5rem;}
button { margin-top:0.5rem; padding:0.5rem 1rem; border:none; border-radius:8px; background:#1abc9c; color:#fff; cursor:pointer;}
</style>
</head>
<body>
<header>KingAutoChat - Admin Dashboard</header>
<div class="container">
  <div class="cases">
    <h3>Cases</h3>
    <div id="cases-list">
      {% for case in cases %}
      <div class="case" onclick="selectCase({{case.id}})">
        {{case.customer_name}} - {{case.status}}
      </div>
      {% endfor %}
    </div>
  </div>
  <div class="chat">
    <h3>Chat</h3>
    <div id="chat-messages" style="display:flex; flex-direction:column;"></div>
    <input type="text" id="message-input" placeholder="พิมพ์ข้อความ..."/>
    <button onclick="sendMessage()">ส่งข้อความ</button>
  </div>
  <div class="profile">
    <h3>Profile</h3>
    <div id="profile-info"></div>
  </div>
</div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
const socket = io();
let currentCase = null;

function selectCase(caseId){
    currentCase = caseId;
    fetch(`/history/${caseId}`).then(r=>r.json()).then(data=>{
        const chatDiv = document.getElementById('chat-messages');
        chatDiv.innerHTML='';
        data.forEach(m=>{
            const div = document.createElement('div');
            div.className='message '+m.from;
            div.innerText=m.message;
            chatDiv.appendChild(div);
        });
    });
}

function sendMessage(){
    const msgInput = document.getElementById('message-input');
    const message = msgInput.value;
    if(!currentCase || !message) return;
    fetch('/send_message',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({case_id:currentCase,message})
    });
    msgInput.value='';
}

socket.on('new_message', data=>{
    if(data.case_id !== currentCase) return;
    const chatDiv = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className='message '+data.message.from;
    div.innerText=data.message.message;
    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
});

socket.on('new_case', caseData=>{
    const div = document.createElement('div');
    div.className='case';
    div.innerText=caseData.customer_name + " - " + caseData.status;
    div.onclick=()=>selectCase(caseData.id);
    document.getElementById('cases-list').appendChild(div);
});

socket.on('update_case', data=>{
    // update status in case list
});
</script>
</body>
</html>
