<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>KingAutoChat</title>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
body { margin:0;font-family:sans-serif; }
.sidebar button { width:100%;padding:5px;margin-bottom:2px;position:relative;text-align:left; }
.badge { background:#4B6CF7;color:white;padding:2px 4px;border-radius:3px;margin-left:5px;font-size:10px; }
.badge-new { background:red;color:white;padding:2px 4px;border-radius:3px;margin-left:5px;font-size:10px; }
.chat-messages div { margin-bottom:5px; }
</style>
</head>
<body>
<main style="display:flex;overflow:hidden; height:100vh;">
  <!-- Sidebar -->
  <div class="sidebar" style="width:250px;border-right:1px solid #ddd;padding:10px;">
    <h2>ผู้ใช้แชท</h2>
    <select id="filterOA"><option value="all">ทุก LINE OA</option></select>
    <select id="filterAdmin"><option value="all">ทุก Admin</option></select>
    <input type="text" id="searchUser" placeholder="ค้นหาลูกค้า..." style="width:100%;margin-top:5px;">
    <div class="user-list" id="userList" style="margin-top:10px;"></div>
  </div>

  <!-- Chat Window -->
  <div class="chat-window" style="flex:1;display:flex;flex-direction:column;">
    <div class="chat-header" id="chatHeader" style="padding:10px;border-bottom:1px solid #ddd;">เลือกผู้ใช้เพื่อเริ่มแชท</div>
    <div class="chat-messages" id="chatMessages" style="flex:1;overflow-y:auto;padding:10px;background:#f0f0f0;"></div>
    <div class="chat-input" style="padding:10px;border-top:1px solid #ddd;display:flex;">
      <input type="text" id="chatInput" placeholder="พิมพ์ข้อความ..." style="flex:1;margin-right:5px;">
      <button id="sendBtn">ส่ง</button>
    </div>
  </div>

  <!-- Profile + History Panel -->
  <div class="right-panel" style="width:300px;border-left:1px solid #ddd;display:flex;flex-direction:column;">
    <!-- Profile -->
    <div class="profile-panel" style="padding:10px;border-bottom:1px solid #ddd;">
      <h3>ข้อมูลลูกค้า</h3>
      <div><b>ชื่อ:</b> <span id="profileName">-</span></div>
      <div><b>ยูสเซอร์:</b> <span id="profileUser">-</span></div>
      <div><b>วันที่สมัคร:</b> <span id="profileReg">-</span></div>
      <div><b>หมายเหตุ:</b></div>
      <textarea id="profileNote" rows="4" style="width:100%;"></textarea>
      <button id="saveNote" style="margin-top:5px;background:#4B6CF7;color:white;border:none;padding:5px 10px;border-radius:5px;">บันทึก</button>
    </div>

    <!-- History -->
    <div class="history-panel" style="flex:1;overflow-y:auto;padding:10px;background:#fff;">
      <h3>ประวัติแชทย้อนหลัง</h3>
      <div id="historyMessages"></div>
    </div>
  </div>
</main>

<script>
const socket = io();
let clients = {};
let currentUserId = null;

const filterOA = document.getElementById('filterOA');
const filterAdmin = document.getElementById('filterAdmin');
const searchUser = document.getElementById('searchUser');
const userList = document.getElementById('userList');
const chatMessages = document.getElementById('chatMessages');
const chatHeader = document.getElementById('chatHeader');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');
const profileNote = document.getElementById('profileNote');
const saveNote = document.getElementById('saveNote');

sendBtn.addEventListener('click',()=>{
    const text = chatInput.value.trim();
    if(text && currentUserId){
        socket.emit('sendMessage',{userId:currentUserId,text});
        chatInput.value='';
    }
});
saveNote.addEventListener('click',()=>{
    if(currentUserId){
        const note = profileNote.value;
        socket.emit('updateProfileNote',{userId:currentUserId,note});
    }
});

function addMessage(userId,sender,text){
    const div = document.createElement('div');
    div.style.textAlign = sender==='admin'?'right':'left';
    div.textContent = `${sender}: ${text}`;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function updateUserList(){
    userList.innerHTML='';
    const oaFilter = filterOA.value;
    const adminFilter = filterAdmin.value;
    const searchText = searchUser.value.toLowerCase();
    for(const userId in clients){
        const client = clients[userId];
        if(oaFilter!=='all' && client.oaName!==oaFilter) continue;
        if(adminFilter!=='all' && client.assignedAdmin!==adminFilter) continue;
        if(searchText && !client.userName.toLowerCase().includes(searchText)) continue;

        const btn = document.createElement('button');
        let label = client.userName;
        if(client.assignedAdmin) label += ` - [${client.assignedAdmin}]`;
        btn.textContent = label;

        const badge = document.createElement('span');
        badge.classList.add('badge');
        badge.textContent = client.oaName;
        btn.appendChild(badge);

        btn.addEventListener('click',()=>{
            if(!client.assignedAdmin){
                const adminName = prompt("กรอกชื่อแอดมินที่จะรับเคส:");
                if(adminName) socket.emit('assignCase',{userId,adminName});
            }
            selectUser(userId);
        });
        userList.appendChild(btn);
    }
}

function selectUser(userId){
    currentUserId = userId;
    const client = clients[userId];
    chatHeader.textContent = `${client.userName} (${client.oaName})`;
    chatMessages.innerHTML='';
    client.messages.forEach(m=>addMessage(userId,m.sender,m.text));
    document.getElementById('profileName').textContent = client.userName;
    document.getElementById('profileUser').textContent = client.profile.username;
    document.getElementById('profileReg').textContent = client.profile.regDate;
    document.getElementById('profileNote').value = client.profile.note;

    fetch(`/history_api/${userId}`).then(res=>res.json()).then(data=>{
        const hist = document.getElementById('historyMessages');
        hist.innerHTML='';
        data.messages.forEach(m=>{
            const div = document.createElement('div');
            div.style.marginBottom='5px';
            div.innerHTML = `<b>${m.sender}</b> [${new Date(m.time).toLocaleString()}]: ${m.text}`;
            hist.appendChild(div);
        });
    });
}

filterOA.addEventListener('change', updateUserList);
filterAdmin.addEventListener('change', updateUserList);
searchUser.addEventListener('input', updateUserList);
</script>
</body>
</html>
