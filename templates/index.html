<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KingAutoChat Admin</title>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
body{display:flex;flex-direction:column;height:100vh;background:#f4f5f7;}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:#4B6CF7;color:white;}
header img{width:40px;height:40px;}
header h1{font-size:1.5rem;margin-left:10px;flex:1;}
header select{padding:5px 10px;border-radius:5px;border:none;font-size:1rem;}
main{flex:1;display:flex;overflow:hidden;}
.sidebar{width:250px;background:#fff;border-right:1px solid #ddd;display:flex;flex-direction:column;}
.sidebar h2{padding:15px;text-align:center;background:#f0f0f0;font-size:1.1rem;border-bottom:1px solid #ddd;}
.user-list{flex:1;overflow-y:auto;}
.user-list button{width:100%;padding:10px;border:none;border-bottom:1px solid #eee;background:none;text-align:left;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:0.2s;}
.user-list button:hover{background:#f0f0f0;}
.user-list .badge{background:#4B6CF7;color:white;padding:2px 6px;border-radius:5px;font-size:0.8rem;}
.user-list button .badge-new{background:red;color:white;font-size:0.7rem;padding:2px 5px;border-radius:50%;margin-left:5px;}
.user-list button .last-msg-time{font-size:0.7rem;color:#999;margin-left:5px;}
.chat-window{flex:1;display:flex;flex-direction:column;background:#fff;}
.chat-header{padding:15px;border-bottom:1px solid #ddd;font-weight:bold;background:#f9f9f9;display:flex;justify-content:space-between;}
.chat-messages{flex:1;padding:15px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;}
.message{display:flex;flex-direction:column;max-width:70%;}
.message.customer{align-self:flex-start;}
.message.admin{align-self:center;}
.message .sender{font-weight:bold;margin-bottom:2px;}
.message .text{padding:8px 12px;border-radius:10px;}
.message.customer .text{background:#f1f1f1;}
.message.admin .text{background:#4B6CF7;color:white;}
.chat-input{display:flex;padding:10px;border-top:1px solid #ddd;background:#f9f9f9;}
.chat-input input{flex:1;padding:10px;border-radius:5px;border:1px solid #ccc;font-size:1rem;}
.chat-input button{margin-left:10px;padding:10px 15px;background:#4B6CF7;color:white;border:none;border-radius:5px;cursor:pointer;}
.user-list::-webkit-scrollbar, .chat-messages::-webkit-scrollbar{width:6px;}
.user-list::-webkit-scrollbar-thumb, .chat-messages::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px;}
</style>
</head>
<body>
<header>
  <img src="https://img.icons8.com/color/48/000000/chat.png" alt="Logo">
  <h1>KingAutoChat Admin</h1>
  <select id="langSelect">
    <option value="th">ไทย</option>
    <option value="en">English</option>
    <option value="jp">日本語</option>
    <option value="cn">中文</option>
    <option value="es">Español</option>
    <option value="fr">Français</option>
  </select>
</header>

<main>
  <div class="sidebar">
    <h2 id="sidebarTitle">ผู้ใช้แชท</h2>
    <div class="user-list" id="userList"></div>
  </div>
  <div class="chat-window">
    <div class="chat-header" id="chatHeader">เลือกผู้ใช้เพื่อเริ่มแชท</div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="พิมพ์ข้อความ...">
      <button id="sendBtn">ส่ง</button>
    </div>
  </div>
</main>

<script>
const socket = io();
let currentUserId = null;
let clients = {}; 

const translations = {
  th:{sidebar:'ผู้ใช้แชท', input:'พิมพ์ข้อความ...', send:'ส่ง', header:'เลือกผู้ใช้เพื่อเริ่มแชท', customer:'ลูกค้า', admin:'คุณ'},
  en:{sidebar:'Chat Users', input:'Type a message...', send:'Send', header:'Select user to start chat', customer:'Customer', admin:'You'},
  jp:{sidebar:'チャットユーザー', input:'メッセージを入力...', send:'送信', header:'ユーザーを選択してチャットを開始', customer:'お客様', admin:'あなた'},
  cn:{sidebar:'聊天用户', input:'输入消息...', send:'发送', header:'选择用户开始聊天', customer:'客户', admin:'您'},
  es:{sidebar:'Usuarios de chat', input:'Escribe un mensaje...', send:'Enviar', header:'Selecciona usuario para chatear', customer:'Cliente', admin:'Tú'},
  fr:{sidebar:'Utilisateurs du chat', input:'Tapez un message...', send:'Envoyer', header:'Sélectionnez un utilisateur pour commencer', customer:'Client', admin:'Vous'}
};

const langSelect = document.getElementById('langSelect');
const userList = document.getElementById('userList');
const chatHeader = document.getElementById('chatHeader');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');

function updateUserList(){
  userList.innerHTML='';
  for(const userId in clients){
    const client = clients[userId];
    const btn = document.createElement('button');
    btn.textContent = client.userName;
    
    const badge = document.createElement('span');
    badge.classList.add('badge');
    badge.textContent = client.oaName;
    btn.appendChild(badge);

    if(client.unread && currentUserId!==userId){
      const newBadge = document.createElement('span');
      newBadge.classList.add('badge-new');
      newBadge.textContent = '!';
      btn.appendChild(newBadge);
    }

    if(client.messages.length>0){
      const lastTime = document.createElement('span');
      lastTime.classList.add('last-msg-time');
      const lastMsg = client.messages[client.messages.length-1];
      lastTime.textContent = formatTime(lastMsg.time);
      btn.appendChild(lastTime);
    }

    btn.addEventListener('click',()=>{
      selectUser(userId);
    });
    userList.appendChild(btn);
  }
}

function selectUser(userId){
  currentUserId = userId;
  const client = clients[userId];
  chatHeader.textContent = `${client.userName} (${client.oaName})`;
  chatMessages.innerHTML='';
  client.messages.forEach(m=>{
    addMessage(userId,m.sender,m.text,m.userName,m.oaName);
  });
  client.unread = false;
  updateUserList();
}

function addMessage(userId,sender,text,userName,oaName){
  const div = document.createElement('div');
  div.classList.add('message', sender==='customer'?'customer':'admin');
  div.innerHTML = `<div class="sender">${sender==='customer'?translations[langSelect.value].customer:translations[langSelect.value].admin} - ${userName}</div><div class="text">${text}</div>`;
  chatMessages.appendChild(div);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

sendBtn.addEventListener('click',()=>{
  const text = chatInput.value.trim();
  if(text && currentUserId){
    socket.emit('sendMessage',{userId:currentUserId,text});
    chatInput.value='';
  }
});

langSelect.addEventListener('change',()=>{
  const lang = langSelect.value;
  document.getElementById('sidebarTitle').textContent = translations[lang].sidebar;
  chatInput.placeholder = translations[lang].input;
  sendBtn.textContent = translations[lang].send;
  if(currentUserId){
    chatHeader.textContent = `${clients[currentUserId].userName} (${clients[currentUserId].oaName})`;
  } else {
    chatHeader.textContent = translations[lang].header;
  }
});

socket.on('newMessage',(data)=>{
  const {userId,sender,text,userName,oaName,time} = data;
  if(!clients[userId]){
    clients[userId] = {messages:[], oaName, userName, unread:true};
  }
  clients[userId].messages.push({sender,text,userName,oaName,time:time||Date.now()});
  if(sender==='customer' && currentUserId!==userId){
    clients[userId].unread = true;
  }
  updateUserList();
  if(currentUserId===userId) addMessage(userId,sender,text,userName,oaName);
});

function formatTime(timestamp){
  const date = new Date(timestamp);
  return `${date.getHours()}:${date.getMinutes().toString().padStart(2,'0')}`;
}
</script>
</body>
</html>
